import{_ as i,c as a,o as n,ag as t}from"./chunks/framework.ko2zIC2c.js";const g=JSON.parse('{"title":"可观测性：分布式链路追踪","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"development/common/distributed-system/observability-trace.md","filePath":"development/common/distributed-system/observability-trace.md","lastUpdated":1768638085000}'),e={name:"development/common/distributed-system/observability-trace.md"};function l(h,s,p,r,k,d){return n(),a("div",null,s[0]||(s[0]=[t(`<h1 id="ke-guan-ce-xingfen-bu-shi-lian-lu-zhui-zong" tabindex="-1">可观测性：分布式链路追踪 <a class="header-anchor" href="#ke-guan-ce-xingfen-bu-shi-lian-lu-zhui-zong" aria-label="Permalink to &quot;可观测性：分布式链路追踪&quot;">​</a></h1><h2 id="jian-jie" tabindex="-1">📖 简介 <a class="header-anchor" href="#jian-jie" aria-label="Permalink to &quot;📖 简介&quot;">​</a></h2><p>分布式链路跟踪（Distributed Tracing）是<strong>可观测性（Observability）</strong> 的核心组成部分之一，用于在复杂的分布式系统（如微服务、Serverless、Service Mesh 等架构）中<strong>追踪一个用户请求从入口到出口所经过的所有服务调用路径</strong>，从而帮助开发者和运维人员快速定位性能瓶颈、错误根源和依赖关系。</p><h2 id="wei-shi-me-xu-yao-fen-bu-shi-lian-lu-gen-zong" tabindex="-1">🤔 为什么需要分布式链路跟踪？ <a class="header-anchor" href="#wei-shi-me-xu-yao-fen-bu-shi-lian-lu-gen-zong" aria-label="Permalink to &quot;🤔 为什么需要分布式链路跟踪？&quot;">​</a></h2><p>在单体应用时代，一次请求只在一个进程中处理，日志集中、调试简单。<br> 但在微服务架构下：</p><ul><li>一个请求可能经过 <strong>10+ 个服务</strong>（如：API Gateway → Auth认证服务 → Order订单服务 → Payment支付服务 → Inventory库存服务 → Notification通知服务）</li><li>每个服务部署在不同主机、容器或区域</li><li>错误可能由某个中间服务的超时、异常或网络问题引起</li></ul><p>此时，仅靠日志难以还原完整调用链。<strong>分布式链路跟踪通过“上下文传播”将分散的调用片段串联成完整的轨迹</strong>。</p><h2 id="he-xin-gai-nian" tabindex="-1">核心概念 <a class="header-anchor" href="#he-xin-gai-nian" aria-label="Permalink to &quot;核心概念&quot;">​</a></h2><p>分布式链路追踪通过为每个请求生成唯一的 <strong>Trace ID</strong>，并在该请求穿越各个服务时传播此 ID，从而将整个调用链上的所有操作串联起来。每个服务在处理请求时会记录一个或多个 <strong>Span</strong>（表示一次操作或子操作），这些 Span 按照父子关系组织成一棵树，构成完整的 <strong>Trace</strong>。</p><ul><li><strong>Trace（追踪）</strong>：代表<strong>一次端到端完整的用户请求</strong>，由多个 Span 组成。例如：“用户下单”是一个 Trace。</li><li><strong>Span（跨度）</strong>：表示 Trace 中的<strong>一个工作单元</strong>，如一次 RPC 调用、数据库查询、函数执行。每个 Span 有开始/结束时间、操作名、标签等。</li><li><strong>Trace ID</strong>：全局唯一 ID，标识整个请求链路。所有相关 Span 共享同一个 Trace ID。</li><li><strong>Span ID</strong>：当前 Span 的唯一 ID。</li><li><strong>Parent Span ID</strong>：父 Span 的 ID，用于构建调用树结构。根 Span 的 Parent ID 为空</li><li><strong>上下文传播（Context Propagation）</strong>：确保 Trace ID 和 Span ID 在服务间正确传递（通常通过 HTTP Header、消息头等）。</li></ul><h2 id="gong-zuo-yuan-li-jian-shu" tabindex="-1">⚙️ 工作原理简述 <a class="header-anchor" href="#gong-zuo-yuan-li-jian-shu" aria-label="Permalink to &quot;⚙️ 工作原理简述&quot;">​</a></h2><ol><li><strong>请求入口</strong>（如网关）生成全局唯一的 <code>Trace ID</code> 和第一个 <code>Span</code>。</li><li>调用下游服务时，将 <code>Trace ID</code>、当前 <code>Span ID</code> 作为 <code>Parent Span ID</code>，通过协议（如 HTTP Header <code>traceparent</code>）传递。</li><li>下游服务接收到请求后，创建自己的 Span，并记录与父 Span 的关系。</li><li>所有 Span 数据被上报到<strong>中央追踪系统</strong>（如 Jaeger、Zipkin）。</li><li>系统根据 Trace ID 聚合所有 Span，重建调用树，并可视化展示（甘特图形式）。</li></ol><p>例如，一个简单的调用链可能如下所示：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">trace_id:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a1b2</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # 整个下单请求的唯一标识</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">├─</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 用户服务：接收下单请求</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # trace_id: a1b2, span_id: a1, parent_span_id: None </span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">  └─</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 调用订单服务：创建订单</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # trace_id: a1b2, span_id: b1, parent_span_id: a1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     ├─</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 订单服务：查询用户信息</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # trace_id: a1b2, span_id: c1, parent_span_id: b1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">     └─</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 订单服务：调用支付服务</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # trace_id: a1b2, span_id: c2, parent_span_id: b1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">└─</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 用户服务：返回下单结果</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">       # trace_id: a1b2, span_id: b2, parent_span_id: a1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Trace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ID:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> a1b2c3d4...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">├──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Span</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> A</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user-service: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">receive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Span</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> B</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (order-service: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">create</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> order</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   │</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   ├──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Span</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> C</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user-service: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">get</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> info</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   │</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   └──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Span</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> D</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (payment-service: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">process</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> payment</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) ← 耗时 800ms</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">│</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">   └──</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Span</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> E</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (user-service: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> response</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><ul><li>同一个请求链路中，所有span的 <code>trace_id</code> 都相同；</li><li>每个span有独立的 <code>span_id</code>，通过 <code>parent_span_id</code> 关联上下游，形成完整的调用树；</li><li>每个span记录自己的操作耗时，能快速定位链路中的性能瓶颈（比如c2耗时过长，说明支付服务慢）。</li></ul><h2 id="zui-jia-shi-jian" tabindex="-1">⭐ 最佳实践 <a class="header-anchor" href="#zui-jia-shi-jian" aria-label="Permalink to &quot;⭐ 最佳实践&quot;">​</a></h2><ol><li><p>全链路注入上下文 (Trace Context)</p><p>在请求入口（如 API 网关）生成全局唯一的 <code>trace_id</code>，并通过以下方式传播：</p><ul><li>HTTP: 使用 <code>traceparent</code>（W3C 标准）Header</li><li>gRPC: 通过 Metadata 传递</li><li>消息队列（Kafka/RabbitMQ）：在消息头中携带上下文</li></ul><p>通过这个方式可以在所有下游服务中透传，便于跨服务日志追踪。</p></li><li><p><strong>结构化日志格式（如 JSON）</strong></p><div class="language-json vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">json</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;timestamp&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;2026-01-17T15:30:00Z&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// 使用 ISO 8601 格式并带时区</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;level&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INFO&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;service&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;order-service&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;trace_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;abc123xyz&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;span_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;span456def&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;message&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Order created successfully&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   &quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;u1001&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></li><li><p><strong>日志采样与分级</strong></p><ul><li>生产环境避免记录过多 DEBUG 日志。</li><li>对高频日志可采用采样策略，防止日志系统过载。</li></ul></li><li><p><strong>安全与合规</strong></p><ul><li>敏感信息（如密码、身份证号）应脱敏。</li><li>日志保留策略需符合 GDPR 等法规。</li></ul></li></ol><h2 id="zhu-liu-fen-bu-shi-lian-lu-zhui-zong-xi-tong-dui-bi" tabindex="-1">主流分布式链路追踪系统对比 <a class="header-anchor" href="#zhu-liu-fen-bu-shi-lian-lu-zhui-zong-xi-tong-dui-bi" aria-label="Permalink to &quot;主流分布式链路追踪系统对比&quot;">​</a></h2><table tabindex="0"><thead><tr><th>方案</th><th>特点</th><th>协议支持</th><th>可视化</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Jaeger</strong></td><td>CNCF 毕业项目，高性能，支持自适应采样</td><td>OpenTracing / OpenTelemetry</td><td>内置 UI，支持依赖图、甘特图</td><td>微服务、K8s、大规模部署</td></tr><tr><td><strong>Zipkin</strong></td><td>轻量，由 Twitter 开源，生态成熟</td><td>Brave (Java), Zipkin API</td><td>简洁 UI，支持服务依赖图</td><td>中小型系统，快速集成</td></tr><tr><td><strong>OpenTelemetry Collector + Backend</strong></td><td>厂商中立，统一标准，未来主流</td><td>OpenTelemetry Protocol (OTLP)</td><td>需搭配 Jaeger/Tempo/Grafana</td><td>新项目首选，长期兼容性好</td></tr><tr><td><strong>Grafana Tempo</strong></td><td>与 Grafana 深度集成，存储成本低</td><td>OTLP, Jaeger, Zipkin</td><td>Grafana 内嵌 Trace 查看</td><td>云原生、已使用 Grafana 的团队</td></tr></tbody></table>`,19)]))}const F=i(e,[["render",l]]);export{g as __pageData,F as default};
