import{_ as i,c as a,o as n,ag as t}from"./chunks/framework.ko2zIC2c.js";const o=JSON.parse('{"title":"Go çš„ Context ä¸Šä¸‹æ–‡","description":"","frontmatter":{"outline":"deep"},"headers":[],"relativePath":"development/go/stdlib/context.md","filePath":"development/go/stdlib/context.md","lastUpdated":1766761225000}'),h={name:"development/go/stdlib/context.md"};function l(e,s,k,p,d,r){return n(),a("div",null,s[0]||(s[0]=[t(`<h1 id="go-de-context-shang-xia-wen" tabindex="-1">Go çš„ Context ä¸Šä¸‹æ–‡ <a class="header-anchor" href="#go-de-context-shang-xia-wen" aria-label="Permalink to &quot;Go çš„ Context ä¸Šä¸‹æ–‡&quot;">â€‹</a></h1><p>Go çš„ <code>Context</code> åŒ…æ˜¯åœ¨ Go 1.7ï¼ˆ2016å¹´ï¼‰æ­£å¼åŠ å…¥æ ‡å‡†åº“çš„ï¼Œå…¶è¯ç”ŸèƒŒæ™¯å’Œæ ¸å¿ƒç›®æ ‡æ˜¯<strong>åœ¨å¹¶å‘ç¨‹åºä¸­å®‰å…¨ã€é«˜æ•ˆåœ°ä¼ é€’è¯·æ±‚èŒƒå›´çš„å…ƒæ•°æ®ã€å–æ¶ˆä¿¡å·å’Œæˆªæ­¢æ—¶é—´</strong>ã€‚å®ƒä¸»è¦è§£å†³ä»¥ä¸‹å‡ ç±»é—®é¢˜ï¼š</p><h2 id="dan-sheng-bei-jing" tabindex="-1">ğŸŒ± è¯ç”ŸèƒŒæ™¯ <a class="header-anchor" href="#dan-sheng-bei-jing" aria-label="Permalink to &quot;ğŸŒ± è¯ç”ŸèƒŒæ™¯&quot;">â€‹</a></h2><p>åœ¨ Go çš„æ—©æœŸå¼€å‘å®è·µä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨æ„å»ºå¤§è§„æ¨¡æœåŠ¡ç«¯åº”ç”¨ï¼ˆå¦‚ HTTP æœåŠ¡ã€gRPC æœåŠ¡ã€å¾®æœåŠ¡æ¶æ„ï¼‰æ—¶ï¼Œå¼€å‘è€…å¸¸å¸¸é¢ä¸´ä»¥ä¸‹æŒ‘æˆ˜ï¼š</p><ol><li><p><strong>å¦‚ä½•åœ¨å¤šä¸ª Goroutine ä¹‹é—´åè°ƒå–æ¶ˆæ“ä½œï¼Ÿ</strong></p><p>ä¾‹å¦‚ï¼šä¸€ä¸ª HTTP è¯·æ±‚è§¦å‘å¤šä¸ªå¹¶å‘å­ä»»åŠ¡ï¼ˆå¦‚æ•°æ®åº“æŸ¥è¯¢ã€RPC è°ƒç”¨ã€ç¼“å­˜è¯»å–ï¼‰ï¼Œå½“å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥æˆ–è¯·æ±‚è¶…æ—¶æ—¶ï¼Œéœ€è¦<strong>åŠæ—¶å–æ¶ˆæ‰€æœ‰ç›¸å…³çš„å­ä»»åŠ¡</strong>ï¼Œé¿å…èµ„æºæµªè´¹ã€‚</p></li><li><p><strong>å¦‚ä½•ä¼ é€’è¯·æ±‚çº§åˆ«çš„æ•°æ®ï¼Ÿ</strong></p><p>æ¯”å¦‚ï¼šé“¾è·¯è¿½è¸ª IDï¼ˆtrace IDï¼‰ã€ç”¨æˆ·èº«ä»½ï¼ˆuser IDï¼‰ã€è¯·æ±‚ IDï¼ˆrequest IDï¼‰ç­‰ï¼Œè¿™äº›æ•°æ®éœ€è¦è´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾ï¼Œä½†åˆä¸é€‚åˆé€šè¿‡å‡½æ•°å‚æ•°å±‚å±‚ä¼ é€’ï¼ˆå°¤å…¶æ˜¯è°ƒç”¨æ·±åº¦å¤§æ—¶ï¼‰ã€‚</p></li><li><p><strong>å¦‚ä½•ç»Ÿä¸€ç®¡ç†è¶…æ—¶å’Œæˆªæ­¢æ—¶é—´ï¼ˆdeadlineï¼‰ï¼Ÿ</strong></p><p>ä¸åŒçš„å­æ“ä½œå¯èƒ½éœ€è¦å…±äº«åŒä¸€ä¸ªè¶…æ—¶ç­–ç•¥ï¼Œè€Œä¸æ˜¯å„è‡ªè®¾ç½®ç‹¬ç«‹çš„è¶…æ—¶ã€‚</p></li></ol><p>åœ¨ <code>context</code> å‡ºç°ä¹‹å‰ï¼Œå¼€å‘è€…å¾€å¾€ä½¿ç”¨å…¨å±€å˜é‡ã€é€šé“ï¼ˆchannelï¼‰æ‰‹åŠ¨ä¼ é€’å–æ¶ˆä¿¡å·ï¼Œæˆ–è‡ªå®šä¹‰ç»“æ„ä½“ï¼Œä½†è¿™äº›æ–¹æ³•ç¼ºä¹ç»Ÿä¸€æ ‡å‡†ï¼Œå®¹æ˜“å‡ºé”™ã€éš¾ä»¥ç»´æŠ¤ï¼Œä¸”ä¸åˆ©äºè·¨åº“åä½œã€‚</p><h2 id="wei-shi-me-xu-yao-context" tabindex="-1">â“ ä¸ºä»€ä¹ˆéœ€è¦ Contextï¼Ÿ <a class="header-anchor" href="#wei-shi-me-xu-yao-context" aria-label="Permalink to &quot;â“ ä¸ºä»€ä¹ˆéœ€è¦ Contextï¼Ÿ&quot;">â€‹</a></h2><p><code>context.Context</code> æä¾›äº†ä¸€ç§ <strong>æ ‡å‡†ã€è½»é‡ã€å¯ç»„åˆ</strong> çš„æœºåˆ¶æ¥è§£å†³ä¸Šè¿°é—®é¢˜ï¼š</p><ul><li><p><strong>å–æ¶ˆä¼ æ’­ï¼ˆCancellation Propagationï¼‰</strong></p><p>é€šè¿‡ <code>context.WithCancel()</code> åˆ›å»ºå¯å–æ¶ˆçš„ä¸Šä¸‹æ–‡ï¼Œè°ƒç”¨ <code>cancel()</code> å¯é€šçŸ¥æ‰€æœ‰ç›‘å¬è€…ã€‚</p></li><li><p><strong>è¶…æ—¶æ§åˆ¶ï¼ˆTimeout / Deadlineï¼‰</strong></p><p><code>context.WithTimeout()</code> / <code>context.WithDeadline()</code> è‡ªåŠ¨åœ¨æ—¶é—´åˆ°è¾¾æ—¶å–æ¶ˆä¸Šä¸‹æ–‡ã€‚</p></li><li><p><strong>æºå¸¦è¯·æ±‚ä½œç”¨åŸŸçš„å€¼ï¼ˆValue Propagationï¼‰</strong></p><p>é€šè¿‡ <code>context.WithValue()</code> æºå¸¦ key-value æ•°æ®ï¼ˆä»…ç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´çš„å…ƒæ•°æ®ï¼Œ<strong>ä¸åº”ç”¨äºä¼ é€’å¯é€‰å‚æ•°æˆ–ä¸šåŠ¡é€»è¾‘æ•°æ®</strong>ï¼‰ã€‚</p></li><li><p><strong>è·¨ Goroutine åä½œ</strong></p><p>æ‰€æœ‰æ´¾ç”Ÿçš„ Goroutine å¯ç›‘å¬åŒä¸€ä¸ª contextï¼Œå®ç°ç»Ÿä¸€å–æ¶ˆã€‚</p></li><li><p>âœ… <strong>æ ‡å‡†æ¥å£ï¼Œç”Ÿæ€ç»Ÿä¸€</strong></p><p>Go æ ‡å‡†åº“ï¼ˆå¦‚ <code>net/http</code>ã€<code>database/sql</code>ï¼‰å’Œä¸»æµç¬¬ä¸‰æ–¹åº“ï¼ˆå¦‚ gRPCã€Ginã€Go-Redisï¼‰éƒ½åŸç”Ÿæ”¯æŒ <code>context</code>ï¼Œå½¢æˆç”Ÿæ€åˆåŠ›ã€‚</p></li></ul><h2 id="context-de-shi-xian-yuan-li" tabindex="-1">âš™ï¸ Context çš„å®ç°åŸç† <a class="header-anchor" href="#context-de-shi-xian-yuan-li" aria-label="Permalink to &quot;âš™ï¸ Context çš„å®ç°åŸç†&quot;">â€‹</a></h2><p>Go çš„ <code>context</code> åŒ…åŸºäº<strong>æ¥å£ + é“¾å¼åŒ…è£…ï¼ˆè£…é¥°å™¨æ¨¡å¼ï¼‰</strong> å®ç°ï¼š</p><h3 id="he-xin-jie-kou" tabindex="-1">æ ¸å¿ƒæ¥å£ <a class="header-anchor" href="#he-xin-jie-kou" aria-label="Permalink to &quot;æ ¸å¿ƒæ¥å£&quot;">â€‹</a></h3><p>Go çš„ <code>context</code> åŒ…å®šä¹‰äº†ä¸€ä¸ªæ ¸å¿ƒæ¥å£ <code>Context</code></p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// A Context carries a deadline, a cancellation signal, and other values across API boundaries.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Context&#39;s methods may be called by multiple goroutines simultaneously.</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Context</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> interface</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è·å–æ“ä½œå®Œæˆçš„æˆªæ­¢æ—¶é—´ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®æˆªæ­¢æ—¶é—´ï¼Œåˆ™è¿”å› ok==falseã€‚</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Deadline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">deadline</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ok</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    </span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // é€šè¿‡ channel ç›‘å¬å–æ¶ˆä¿¡å·</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¿”å›ä¸€ä¸ªåªè¯» channelï¼Œå½“ context è¢«å–æ¶ˆæˆ–è¶…æ—¶æ—¶ï¼Œè¯¥ channel ä¼šè¢«å…³é—­ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å¦‚æœ context æ°¸è¿œä¸ä¼šè¢«å–æ¶ˆï¼ˆå¦‚ Background()ï¼‰ï¼Œåˆ™è¿”å› nilã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å½“ä½ è°ƒç”¨ context çš„ cancel å‡½æ•°åï¼ŒDone é€šé“çš„å…³é—­å¹¶ä¸æ˜¯ç«‹å³å‘ç”Ÿçš„ï¼Œè€Œæ˜¯åœ¨ cancel å‡½æ•°è¿”å›ä¹‹åçš„æŸä¸ªæ—¶åˆ»å¼‚æ­¥å®Œæˆçš„ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // å®˜æ–¹ç¤ºä¾‹ï¼šhttps://blog.golang.org/pipelines</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;-chan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // è¿”å›å–æ¶ˆåŸå› ï¼ˆå¦‚ \`context.Canceled\` æˆ– \`context.DeadlineExceeded\`ï¼‰ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ç”¨äºè·å–ç»‘å®šåœ¨ context ä¸Šçš„å€¼ï¼Œå¦‚æœæ²¡æœ‰ä¸ key å…³è”çš„å€¼åˆ™è¿”å› nilã€‚ï¼ˆæ³¨æ„ï¼škey åº”ä¸ºéå¯¼å‡ºç±»å‹ï¼Œé¿å…å†²çªï¼‰ã€‚</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="chang-jian-shi-xian-lei-xingsi-you-jie-gou-ti" tabindex="-1">å¸¸è§å®ç°ç±»å‹ï¼ˆç§æœ‰ç»“æ„ä½“ï¼‰ <a class="header-anchor" href="#chang-jian-shi-xian-lei-xingsi-you-jie-gou-ti" aria-label="Permalink to &quot;å¸¸è§å®ç°ç±»å‹ï¼ˆç§æœ‰ç»“æ„ä½“ï¼‰&quot;">â€‹</a></h3><ul><li><p><code>emptyCtx</code>ï¼šç©ºä¸Šä¸‹æ–‡ï¼Œå¦‚ <code>context.Background()</code> å’Œ <code>context.TODO()</code></p></li><li><p><code>cancelCtx</code>ï¼šæ”¯æŒæ‰‹åŠ¨å–æ¶ˆï¼ˆ<code>WithCancel</code>ï¼‰</p></li><li><p><code>timerCtx</code>ï¼šåœ¨ <code>cancelCtx</code> åŸºç¡€ä¸ŠåŠ äº† timerï¼Œæ”¯æŒè¶…æ—¶ï¼ˆ<code>WithTimeout</code> / <code>WithDeadline</code>ï¼‰</p></li><li><p><code>valueCtx</code>ï¼šåŒ…è£…çˆ¶ contextï¼Œå¹¶é™„åŠ  key-value å¯¹ï¼ˆ<code>WithValue</code>ï¼‰</p></li></ul><h3 id="lian-shi-jie-goushu-xing-pai-sheng" tabindex="-1">é“¾å¼ç»“æ„ï¼ˆæ ‘å½¢æ´¾ç”Ÿï¼‰ <a class="header-anchor" href="#lian-shi-jie-goushu-xing-pai-sheng" aria-label="Permalink to &quot;é“¾å¼ç»“æ„ï¼ˆæ ‘å½¢æ´¾ç”Ÿï¼‰&quot;">â€‹</a></h3><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Background() [context.emptyCtx]</span></span>
<span class="line"><span>â”‚</span></span>
<span class="line"><span>â”œâ”€ WithCancel() â†’ ctx1 [context.cancelCtx]</span></span>
<span class="line"><span>â”‚   â””â”€ WithTimeout() â†’ ctx2 [context.timerCtx]</span></span>
<span class="line"><span>â”‚       â””â”€ WithValue() â†’ ctx3 [context.valueCtx]</span></span>
<span class="line"><span>â”‚</span></span>
<span class="line"><span>â””â”€ WithDeadline() â†’ ctx4 [context.timerCtx]</span></span>
<span class="line"><span>    â””â”€ WithValue() â†’ ctx5 [context.valueCtx]</span></span></code></pre></div><p>æ¯æ¬¡è°ƒç”¨ <code>WithXXX</code> éƒ½ä¼š<strong>è¿”å›ä¸€ä¸ªæ–°çš„ context åŒ…è£…æ—§çš„ context</strong>ï¼Œå½¢æˆä¸€æ¡çˆ¶å­é“¾ã€‚å–æ¶ˆä¿¡å·ä»å­å‘çˆ¶ä¼ æ’­ï¼ˆå®é™…æ˜¯çˆ¶ context è¢«å–æ¶ˆæ—¶ï¼Œä¼šå…³é—­æ‰€æœ‰å­ context çš„ Done é€šé“ï¼‰ã€‚</p><p><code>WithValue</code> ä¸ä¼šå½±å“å–æ¶ˆæˆ–è¶…æ—¶è¡Œä¸ºï¼Œå®ƒåªæ˜¯é™„åŠ æ•°æ®ã€‚</p><h2 id="gen-contextroot-context" tabindex="-1">ğŸŒ³ æ ¹ Contextï¼ˆRoot Contextï¼‰ <a class="header-anchor" href="#gen-contextroot-context" aria-label="Permalink to &quot;ğŸŒ³ æ ¹ Contextï¼ˆRoot Contextï¼‰&quot;">â€‹</a></h2><p>æ ¹ Context æ˜¯æ•´ä¸ªä¸Šä¸‹æ–‡æ ‘çš„<strong>èµ·ç‚¹</strong>ï¼Œæ— æ³•è¢«å–æ¶ˆã€æ²¡æœ‰è¶…æ—¶ã€ä¹Ÿä¸æºå¸¦å€¼ã€‚</p><p>Go æä¾›äº†ä¸¤ä¸ªé¢„å®šä¹‰çš„æ ¹ Contextï¼š</p><ul><li><code>context.Background()</code></li><li><code>context.TODO()</code></li></ul><p>ä¸€èˆ¬åœ¨æœåŠ¡å…¥å£ï¼ˆå¦‚ <code>main()</code>ã€HTTP handlerï¼‰ä½¿ç”¨ <code>Background()</code>ï¼›åœ¨å°šæœªæ˜ç¡®ä¸Šä¸‹æ–‡æ¥æºçš„ä¸­é—´å±‚å‡½æ•°ä½¿ç”¨ <code>TODO()</code> ä½œä¸ºä¸´æ—¶æ–¹æ¡ˆã€‚</p><h3 id="contextbackground" tabindex="-1"><code>context.Background()</code> <a class="header-anchor" href="#contextbackground" aria-label="Permalink to &quot;\`context.Background()\`&quot;">â€‹</a></h3><ul><li><strong>ç”¨é€”</strong>ï¼šä½œä¸º<strong>ä¸»å‡½æ•°ã€åˆå§‹åŒ–è¿‡ç¨‹æˆ–æµ‹è¯•</strong>ä¸­åˆ›å»ºæ–°ä¸Šä¸‹æ–‡çš„èµ·ç‚¹ã€‚</li><li><strong>è¯­ä¹‰</strong>ï¼šè¡¨ç¤ºâ€œåå°â€æˆ–â€œé¡¶å±‚â€æ“ä½œï¼Œé€šå¸¸ç”¨äºæœåŠ¡å¯åŠ¨ã€åå°ä»»åŠ¡ç­‰ã€‚</li><li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šæ°¸ä¸å–æ¶ˆï¼Œä¸€ç›´æœ‰æ•ˆã€‚</li></ul><h3 id="contexttodo" tabindex="-1"><code>context.TODO()</code> <a class="header-anchor" href="#contexttodo" aria-label="Permalink to &quot;\`context.TODO()\`&quot;">â€‹</a></h3><ul><li><strong>ç”¨é€”</strong>ï¼šå½“ä½ <strong>è¿˜ä¸ç¡®å®šè¯¥ç”¨å“ªä¸ª Context</strong>ï¼ˆä¾‹å¦‚æ­£åœ¨é‡æ„ä»£ç ã€å°šæœªé›†æˆä¸Šä¸‹æ–‡ï¼‰ï¼Œä½œä¸ºå ä½ç¬¦ã€‚</li><li><strong>è¯­ä¹‰</strong>ï¼šè¡¨ç¤ºâ€œå¾…åŠâ€ï¼Œæé†’å¼€å‘è€…åç»­åº”æ›¿æ¢ä¸ºåˆé€‚çš„ä¸Šä¸‹æ–‡ã€‚</li><li><strong>è¡Œä¸º</strong>ï¼šä¸ <code>Background()</code> å®Œå…¨ç›¸åŒï¼Œä»…ç”¨äºä»£ç å¯è¯»æ€§å’Œæ„å›¾è¡¨è¾¾ã€‚</li></ul><h2 id="pai-sheng-contextderived-context" tabindex="-1">ğŸŒ¿ æ´¾ç”Ÿ Contextï¼ˆDerived Contextï¼‰ <a class="header-anchor" href="#pai-sheng-contextderived-context" aria-label="Permalink to &quot;ğŸŒ¿ æ´¾ç”Ÿ Contextï¼ˆDerived Contextï¼‰&quot;">â€‹</a></h2><p>é€šè¿‡æ ¹ Contextï¼ˆæˆ–å·²æœ‰æ´¾ç”Ÿ Contextï¼‰è°ƒç”¨ <code>context</code> åŒ…æä¾›çš„æ„é€ å‡½æ•°ï¼Œå¯ä»¥åˆ›å»º<strong>æ´¾ç”Ÿ Context</strong>ã€‚æ´¾ç”Ÿ Context ä¼š<strong>ç»§æ‰¿çˆ¶ Context çš„æ‰€æœ‰å±æ€§</strong>ï¼ˆå–æ¶ˆã€è¶…æ—¶ã€å€¼ï¼‰ï¼Œå¹¶å¯å åŠ æ–°è¡Œä¸ºã€‚</p><p>Go æä¾›äº†å››ç§ä¸»è¦çš„æ´¾ç”Ÿæ–¹æ³•ï¼š</p><ul><li><code>WithCancel</code>ï¼šåˆ›å»ºä¸€ä¸ªå¯æ‰‹åŠ¨å–æ¶ˆçš„ Contextã€‚</li><li><code>WithTimeout</code>ï¼šåœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨å–æ¶ˆ Contextã€‚</li><li><code>WithDeadline</code>ï¼šåœ¨æŒ‡å®š<strong>ç»å¯¹æ—¶é—´ç‚¹</strong>è‡ªåŠ¨å–æ¶ˆ Contextã€‚</li><li><code>WithValue</code>ï¼šå‘ Context ä¸­é™„åŠ è¯·æ±‚ä½œç”¨åŸŸçš„å€¼ã€‚</li></ul><h3 id="contextwithcancelparent-context" tabindex="-1"><code>context.WithCancel(parent Context)</code> <a class="header-anchor" href="#contextwithcancelparent-context" aria-label="Permalink to &quot;\`context.WithCancel(parent Context)\`&quot;">â€‹</a></h3><p>åˆ›å»ºä¸€ä¸ªå¯æ‰‹åŠ¨å–æ¶ˆçš„ Contextï¼Œè¿”å› <code>context.cancelCtx</code> ç±»å‹</p><ul><li>å‡½æ•°ç­¾åï¼š<code>func WithCancel(parent Context) (ctx Context, cancel CancelFunc)</code></li></ul><h4 id="cancelctx-shi-li" tabindex="-1"><code>cancelCtx</code> ç¤ºä¾‹ <a class="header-anchor" href="#cancelctx-shi-li" aria-label="Permalink to &quot;\`cancelCtx\` ç¤ºä¾‹&quot;">â€‹</a></h4><p>å¯åŠ¨å¤šä¸ª Goroutineï¼Œéœ€åœ¨æ»¡è¶³æ¡ä»¶æ—¶ç»Ÿä¸€å–æ¶ˆã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">parentCtx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithCancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parentCtx)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">go</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // æ”¶åˆ°å–æ¶ˆä¿¡å·ï¼Œä¼˜é›…é€€å‡º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;goroutine canceled:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">            return</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        default</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // æ‰§è¡Œä»»åŠ¡</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;goroutine running&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Sleep</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.Second)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ‰‹åŠ¨è§¦å‘å–æ¶ˆ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// è¾“å‡ºï¼š</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// goroutine running</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// goroutine running</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// goroutine canceled: context canceled</span></span></code></pre></div><p>é€šå¸¸æ¥è¯´ï¼Œå½“å‰å‡½æ•°ç»“æŸå‰éœ€è¦æ‰‹åŠ¨å–æ¶ˆï¼Œä½¿ç”¨ <code>defer cancel()</code> æ¥ç¡®ä¿èµ„æºé‡Šæ”¾æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithCancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><h4 id="cancelctx-shi-xian-yuan-li" tabindex="-1"><code>cancelCtx</code> å®ç°åŸç† <a class="header-anchor" href="#cancelctx-shi-xian-yuan-li" aria-label="Permalink to &quot;\`cancelCtx\` å®ç°åŸç†&quot;">â€‹</a></h4><p>Go 1.19 ä¹‹åï¼Œ <code>cancelCtx</code> çš„ç»“æ„ä½“å®šä¹‰ä¸ºï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancelCtx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Context</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mu       </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sync</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Mutex</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // protects following fields</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    done     </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // of chan struct{}, created lazily, closed by first cancel call</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    children </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">canceler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{} </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// set to nil by the first cancel call</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    err      </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">atomic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          // set to non-nil by the first cancel call</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    cause    </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                 // set to non-nil by the first cancel call</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>å½“ä¸€ä¸ªç”± <code>context.WithCancel</code>ã€<code>WithTimeout</code> æˆ– <code>WithDeadline</code> åˆ›å»ºçš„ Context è¢«å–æ¶ˆæ—¶ï¼ˆæ— è®ºæ‰‹åŠ¨è°ƒç”¨ <code>cancel()</code> è¿˜æ˜¯è¶…æ—¶è‡ªåŠ¨è§¦å‘ï¼‰ï¼Œå…¶åº•å±‚å¯¹åº”çš„ <code>*cancelCtx</code>ï¼ˆæˆ–åµŒå…¥å®ƒçš„ <code>*timerCtx</code>ï¼‰çš„ <code>cancel(removeFromParent bool, err, cause error)</code> æ–¹æ³•ä¼šè¢«è°ƒç”¨ï¼Œä»è€Œå®Œæˆå–æ¶ˆä¼ æ’­ã€å…³é—­ Done é€šé“ç­‰æ“ä½œã€‚</p><p><code>cancelCtx</code> çš„ cancel æ–¹æ³•å®šä¹‰å¦‚ä¸‹ï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancelCtx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">removeFromParent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cause</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>å‚è€ƒ <code>cancel</code> <a href="https://github.com/golang/go/blob/6e676ab2b809d46623acb5988248d95d1eb7939c/src/context/context.go#L547" target="_blank" rel="noreferrer">æºç </a>ï¼Œå…¶å¤„ç†é€»è¾‘ä¸ºï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancelCtx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">removeFromParent</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">cause</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ... å‚æ•°æ ¡éªŒ ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    c.mu.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Lock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    defer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.mu.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Unlock</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®é™…æ˜¯åé¢æ‰‹åŠ¨ unlockï¼Œä½†é€»è¾‘ä¸Šæ˜¯æŒæœ‰é”æ‰§è¡Œå…¨éƒ¨å…³é”®æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 1ï¸âƒ£ æ£€æŸ¥æ˜¯å¦å·²å–æ¶ˆï¼ˆå¹‚ç­‰æ€§ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // å·²å–æ¶ˆï¼Œç›´æ¥é€€å‡º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 2ï¸âƒ£ åŸå­è®¾ç½®é”™è¯¯å’Œ cause</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    c.err.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(err)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    c.cause </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> cause</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 3ï¸âƒ£ å…³é—­ done channelï¼ˆæˆ–æŒ‡å‘å…¨å±€ closedchanï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    d, _ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.done.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Load</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">chan</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{})</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> d </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        c.done.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Store</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(closedchan) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¼˜åŒ–ï¼šç›´æ¥æŒ‡å‘é¢„å…³é—­çš„ channel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        close</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(d) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¦‚æœå·²åˆ›å»ºï¼Œå°±å…³é—­å®ƒ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 4ï¸âƒ£ é€’å½’å–æ¶ˆæ‰€æœ‰å­ contextï¼ˆæŒæœ‰é”æœŸé—´ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> child </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.children { child.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, err, cause) }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    c.children </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> nil</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // é˜²æ­¢é‡å¤å–æ¶ˆï¼Œä¹Ÿå¸®åŠ© GC</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // 5ï¸âƒ£ ä»çˆ¶ context ä¸­ç§»é™¤è‡ªå·±ï¼ˆå¦‚æœéœ€è¦ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> removeFromParent { </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">removeChild</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(c.Context, c) }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>cancelCtx.cancel</code> æ–¹æ³•ç¡®ä¿äº†ï¼š</p><ul><li>å¹‚ç­‰æ€§ï¼šå¤šæ¬¡è°ƒç”¨åªä¼šç”Ÿæ•ˆä¸€æ¬¡ã€‚</li><li>é€’å½’å–æ¶ˆæ‰€æœ‰å­ contextã€‚</li><li>ä»çˆ¶ context ä¸­ç§»é™¤è‡ªå·±ï¼Œé¿å…å†…å­˜æ³„æ¼ã€‚</li><li>çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥åœ¨å¤šä¸ª Goroutine ä¸­å¹¶å‘è°ƒç”¨ã€‚é€šè¿‡ <code>sync.Mutex</code> ä¿è¯å…³é”®åŒºäº’æ–¥ï¼Œå¹¶ä½¿ç”¨ <code>atomic.Value</code> å®ç°æ— é”è¯»å–çŠ¶æ€ï¼Œå®Œæˆäº†â€œå…ˆæ£€æŸ¥åæ‰§è¡Œâ€æ¨¡å¼å®ç°å¹‚ç­‰æ€§ã€‚</li></ul><h3 id="contextwithtimeoutparent-context-timeout-timeduration" tabindex="-1"><code>context.WithTimeout(parent Context, timeout time.Duration)</code> <a class="header-anchor" href="#contextwithtimeoutparent-context-timeout-timeduration" aria-label="Permalink to &quot;\`context.WithTimeout(parent Context, timeout time.Duration)\`&quot;">â€‹</a></h3><p>åˆ›å»ºä¸€ä¸ª<strong>åœ¨æŒ‡å®šæ—¶é—´åè‡ªåŠ¨å–æ¶ˆ</strong>çš„ Contextï¼Œè¿”å› <code>context.timerCtx</code> ç±»å‹ï¼Œç­‰ä»·äº <code>WithDeadline(parent, time.Now().Add(timeout))</code></p><ul><li><p>å‡½æ•°ç­¾åï¼š<code>func WithTimeout(parent Context, timeout time.Duration) (ctx Context, cancel CancelFunc)</code></p></li><li><p><strong>æ³¨æ„</strong>ï¼š<strong>å¿…é¡»è°ƒç”¨ <code>cancel()</code></strong>ï¼ˆå³ä½¿è¶…æ—¶ä¹Ÿä¼šè‡ªåŠ¨å–æ¶ˆï¼Œä½†è°ƒç”¨å¯é‡Šæ”¾èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼ï¼‰ã€‚</p></li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.Second)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¨è always defer cancel()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">After</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.Second):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;done&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;timeout:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// context.DeadlineExceeded</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="contextwithdeadlineparent-context-d-timetime" tabindex="-1"><code>context.WithDeadline(parent Context, d time.Time)</code> <a class="header-anchor" href="#contextwithdeadlineparent-context-d-timetime" aria-label="Permalink to &quot;\`context.WithDeadline(parent Context, d time.Time)\`&quot;">â€‹</a></h3><p>åœ¨æŒ‡å®š<strong>ç»å¯¹æ—¶é—´ç‚¹</strong>è‡ªåŠ¨å–æ¶ˆ Contextï¼Œè¿”å› <code>context.timerCtx</code> ç±»å‹ã€‚</p><ul><li>å‡½æ•°ç­¾åï¼š<code>func WithDeadline(parent Context, d time.Time) (ctx Context, cancel CancelFunc)</code></li><li>ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦ä¸ç³»ç»Ÿæ—¶é’Ÿå¯¹é½çš„æˆªæ­¢æ—¶é—´ï¼ˆå¦‚ API è°ƒç”¨æˆªæ­¢åˆ° 10:00ï¼‰ã€‚</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">deadline </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Now</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Add</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> time.Second)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithDeadline</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), deadline)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><h3 id="contextwithvalueparent-context-key-val-any" tabindex="-1"><code>context.WithValue(parent Context, key, val any)</code> <a class="header-anchor" href="#contextwithvalueparent-context-key-val-any" aria-label="Permalink to &quot;\`context.WithValue(parent Context, key, val any)\`&quot;">â€‹</a></h3><p>å‘ Context ä¸­<strong>é™„åŠ è¯·æ±‚ä½œç”¨åŸŸçš„å€¼</strong>ï¼ˆå¦‚ trace IDã€user IDï¼‰ï¼Œè¿”å› <code>context.valueCtx</code> ç±»å‹ã€‚</p><ul><li>å‡½æ•°ç­¾åï¼š<code>func WithValue(parent Context, key, val any) Context</code></li></ul><h4 id="shi-xian-yuan-li" tabindex="-1">å®ç°åŸç† <a class="header-anchor" href="#shi-xian-yuan-li" aria-label="Permalink to &quot;å®ç°åŸç†&quot;">â€‹</a></h4><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> valueCtx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Context</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // çˆ¶ contextï¼ˆåªè¯»å¼•ç”¨ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    key, val </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">parent</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">val</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç®€åŒ–çš„å®ç°</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">valueCtx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{parent, key, val}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="key-bi-xu-shi-ke-bi-jiao-de-lei-xing" tabindex="-1">key å¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„ç±»å‹ <a class="header-anchor" href="#key-bi-xu-shi-ke-bi-jiao-de-lei-xing" aria-label="Permalink to &quot;key å¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„ç±»å‹&quot;">â€‹</a></h4><p>å› ä¸º <code>key</code> çš„æ¯”è¾ƒä½¿ç”¨ <code>==</code>ï¼Œå› æ­¤ <strong>key å¿…é¡»æ˜¯å¯æ¯”è¾ƒç±»å‹ï¼ˆcomparableï¼‰</strong> â€”â€” è¿™æ˜¯ Go ç±»å‹ç³»ç»Ÿçš„è¦æ±‚ã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> valueCtx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    Context</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // çˆ¶ context</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    key, val </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">c </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">valueCtx</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">key</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">any</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.key </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> key { </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ³¨æ„ï¼šè¿™é‡Œæ˜¯ == æ¯”è¾ƒï¼Œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.val</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> c.Context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(key) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// é€’å½’å‘ä¸ŠæŸ¥æ‰¾</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h4 id="fu-zi-ke-jian-xing-shi-dan-xiang-de" tabindex="-1">çˆ¶å­å¯è§æ€§æ˜¯å•å‘çš„ <a class="header-anchor" href="#fu-zi-ke-jian-xing-shi-dan-xiang-de" aria-label="Permalink to &quot;çˆ¶å­å¯è§æ€§æ˜¯å•å‘çš„&quot;">â€‹</a></h4><p>å€¼æŸ¥æ‰¾æ˜¯é“¾å¼å‘ä¸Šçš„ï¼Œå­ Context èƒ½è®¿é—®çˆ¶çš„æ‰€æœ‰å€¼ï¼Œä½†çˆ¶ Context å¯¹å­é™„åŠ çš„å€¼å®Œå…¨ä¸å¯è§ã€‚</p><p>è°ƒç”¨ <code>ctx.Value(key)</code> æ—¶ï¼Œè‹¥å½“å‰ <code>valueCtx</code> çš„ key ä¸åŒ¹é…ï¼Œåˆ™<strong>é€’å½’è°ƒç”¨ <code>parent.Value(key)</code></strong>ï¼Œç›´åˆ°æ ¹ Contextï¼ˆ<code>Background</code>/<code>TODO</code>ï¼‰ï¼Œè‹¥æ‰¾ä¸åˆ°åˆ™è¿”å› <code>nil</code>ã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> keyA</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> keyB</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keyA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;A&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx1, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keyB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;B&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Background</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// â””â”€ ctx1 (keyA: &quot;A&quot;)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">//     â””â”€ ctx2 (keyB: &quot;B&quot;)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keyA</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{})) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;A&quot;ï¼ˆä» ctx1 ç»§æ‰¿ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keyB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{})) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;B&quot;ï¼ˆè‡ªèº«ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">keyB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{})) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// nilï¼ˆçˆ¶çœ‹ä¸åˆ°å­çš„å€¼ï¼‰</span></span></code></pre></div><h4 id="value-de-bu-ke-bian-te-xing" tabindex="-1">Value çš„ä¸å¯å˜ç‰¹æ€§ <a class="header-anchor" href="#value-de-bu-ke-bian-te-xing" aria-label="Permalink to &quot;Value çš„ä¸å¯å˜ç‰¹æ€§&quot;">â€‹</a></h4><p><code>context.WithValue</code> è¿”å›çš„ <code>*valueCtx</code> æ˜¯ä¸å¯å˜çš„ã€‚<code>WithValue</code> å‡½æ•°æ€»æ˜¯è¿”å›ä¸€ä¸ªæ–°çš„ <code>*valueCtx</code>ï¼Œä¸ä¼šä¿®æ”¹åŸ Contextã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx1 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;value1&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ctx1: key â†’ &quot;value1&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx2 </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx1, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;value2&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ctx2: key â†’ &quot;value2&quot;ï¼Œä½† ctx1 ä¸å˜</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx1.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;value1&quot; âœ…</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx2.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;key&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// &quot;value2&quot; âœ…</span></span></code></pre></div><h2 id="context-qu-xiao-ji-zhi" tabindex="-1">ğŸš« Context å–æ¶ˆæœºåˆ¶ <a class="header-anchor" href="#context-qu-xiao-ji-zhi" aria-label="Permalink to &quot;ğŸš« Context å–æ¶ˆæœºåˆ¶&quot;">â€‹</a></h2><p>è°ƒç”¨ <code>cancel()</code>ï¼ˆç”± <code>WithCancel</code>ã€<code>WithTimeout</code>ã€<code>WithDeadline</code> è¿”å›ï¼‰æ—¶ï¼ŒGo è¿è¡Œæ—¶ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ol><li><p><strong>å…³é—­ <code>Done()</code> channel</strong></p><p>æ‰€æœ‰ç›‘å¬ <code>&lt;-ctx.Done()</code> çš„ goroutine ä¼šç«‹å³æ”¶åˆ°é€šçŸ¥ã€‚</p></li><li><p><strong>è®¾ç½®å†…éƒ¨ <code>err</code> å­—æ®µä¸º <code>context.Canceled</code></strong>ï¼ˆæˆ– <code>DeadlineExceeded</code>ï¼‰</p><p>åç»­è°ƒç”¨ <code>ctx.Err()</code> å°†è¿”å›è¯¥é”™è¯¯ã€‚</p></li><li><p><strong>é€’å½’å–æ¶ˆæ‰€æœ‰å­ Context</strong></p><p>Context å†…éƒ¨ç»´æŠ¤ä¸€ä¸ª <code>children</code> æ˜ å°„ï¼ˆmapï¼‰ï¼Œä¿å­˜æ‰€æœ‰ç›´æ¥æ´¾ç”Ÿçš„å­ contextã€‚å–æ¶ˆæ—¶ä¼šéå†è¯¥ mapï¼Œ<strong>é€’å½’è°ƒç”¨å­ context çš„ cancel å‡½æ•°</strong>ï¼Œä»è€Œå®ç°<strong>çº§è”å–æ¶ˆ</strong>ã€‚</p></li><li><p><strong>ä»çˆ¶ Context çš„ <code>children</code> ä¸­ç§»é™¤è‡ªèº«</strong></p><p>é¿å…å›  parent æŒæœ‰ child å¼•ç”¨è€Œå¯¼è‡´<strong>å†…å­˜æ³„æ¼</strong>ï¼ˆå°¤å…¶åœ¨ child å…ˆäº parent ç»“æŸçš„åœºæ™¯ï¼‰ã€‚</p></li></ol><blockquote><p>ğŸ“Œ è¿™ä¸€æœºåˆ¶ç¡®ä¿äº†ï¼š<strong>åªè¦å–æ¶ˆæ ‘ä¸­ä»»æ„ä¸€ä¸ªéå¶å­èŠ‚ç‚¹ï¼Œå…¶æ•´ä¸ªå­æ ‘éƒ½ä¼šè¢«å–æ¶ˆ</strong>ã€‚</p></blockquote><div class="language-txt vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">txt</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Background()</span></span>
<span class="line"><span>â”‚</span></span>
<span class="line"><span>â”œâ”€ WithCancel() â†’ ctx1</span></span>
<span class="line"><span>â”‚   â””â”€ WithTimeout() â†’ ctx2</span></span>
<span class="line"><span>â”‚       â””â”€ WithValue() â†’ ctx3</span></span>
<span class="line"><span>â”‚</span></span>
<span class="line"><span>â””â”€ WithDeadline() â†’ ctx4</span></span>
<span class="line"><span>    â””â”€ WithValue() â†’ ctx5</span></span></code></pre></div><ul><li><p><strong>å–æ¶ˆ <code>ctx1</code></strong></p><ul><li>è§¦å‘ <code>ctx1.cancel()</code></li><li>é€’å½’å–æ¶ˆ <code>ctx2</code></li><li><code>ctx2</code> å†å–æ¶ˆ <code>ctx3</code></li><li><strong><code>ctx2</code> å’Œ <code>ctx3</code> çš„ <code>Done()</code> å…³é—­ï¼Œ<code>Err()</code> è¿”å› <code>Canceled</code></strong></li></ul></li><li><p><strong><code>ctx3</code> å’Œ <code>ctx5</code> æ˜¯åªè¯»çš„å¶å­</strong></p><ul><li>å®ƒä»¬é€šè¿‡ <code>WithValue</code> æºå¸¦æ•°æ®ï¼ˆå¦‚ <code>requestID</code>ï¼‰</li><li><strong>ä¸æä¾› <code>cancel</code> å‡½æ•°</strong>ï¼ˆ<code>context.WithValue</code> ä¸è¿”å› cancelï¼‰</li><li>ä½†èƒ½<strong>ç»§æ‰¿ç¥–å…ˆçš„å–æ¶ˆ/è¶…æ—¶ä¿¡å·</strong>ï¼ˆå› ä¸º <code>Done()</code> å’Œ <code>Err()</code> å‘ä¸Šä¼ é€’ï¼‰</li></ul></li></ul><blockquote><p>ğŸ” æ³¨æ„ï¼š<code>WithValue</code> è¿”å›çš„ context ä»ç„¶æŒæœ‰å¯¹çˆ¶ context çš„å¼•ç”¨ï¼Œæ‰€ä»¥å®ƒèƒ½æ­£ç¡®å“åº”ç¥–å…ˆçš„å–æ¶ˆã€‚</p></blockquote><h2 id="ctxerr-de-fan-hui-zhi" tabindex="-1">ğŸ“Œ <code>ctx.Err()</code> çš„è¿”å›å€¼ <a class="header-anchor" href="#ctxerr-de-fan-hui-zhi" aria-label="Permalink to &quot;ğŸ“Œ \`ctx.Err()\` çš„è¿”å›å€¼&quot;">â€‹</a></h2><p><code>context.Context</code> çš„ <code>Err()</code> æ–¹æ³•åœ¨ä¸Šä¸‹æ–‡è¢«å–æ¶ˆæˆ–è¶…æ—¶æ—¶è¿”å›ä¸€ä¸ªé”™è¯¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><ul><li><strong><code>context.Canceled</code></strong>ï¼šå½“ä¸Šæ¸¸ä¸»åŠ¨è°ƒç”¨ <code>cancel()</code> å‡½æ•°å–æ¶ˆä¸Šä¸‹æ–‡æ—¶è¿”å›ã€‚</li><li><strong><code>context.DeadlineExceeded</code></strong>ï¼šå½“ä¸Šä¸‹æ–‡è®¾ç½®äº†æˆªæ­¢æ—¶é—´ï¼ˆdeadlineï¼‰ä¸”æ—¶é—´åˆ°è¾¾æ—¶è¿”å›ã€‚</li></ul><p>è¿™ä¸¤ä¸ªé”™è¯¯éƒ½å®ç°äº† <code>error</code> æ¥å£ï¼Œä¸”æ˜¯<strong>å¯æ¯”è¾ƒçš„</strong>ï¼ˆå¯ä»¥ç”¨ <code>errors.Is</code> æˆ–ç›´æ¥ <code>==</code> åˆ¤æ–­ï¼‰ï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Is</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), context.Canceled) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Request was canceled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Is</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), context.DeadlineExceeded) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Request deadline exceeded&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><blockquote><p>æ³¨æ„ï¼šä» Go 1.13 èµ·æ¨èä½¿ç”¨ <code>errors.Is</code>ï¼Œä½†å› ä¸ºè¿™ä¸¤ä¸ªé”™è¯¯æ˜¯å“¨å…µé”™è¯¯ï¼ˆsentinel errorsï¼‰ï¼Œç›´æ¥ <code>==</code> ä¹Ÿæ˜¯å®‰å…¨çš„ã€‚</p></blockquote><h2 id="go-117-de-you-huabu-chong-shuo-ming" tabindex="-1">ğŸš€ Go 1.17+ çš„ä¼˜åŒ–ï¼ˆè¡¥å……è¯´æ˜ï¼‰ <a class="header-anchor" href="#go-117-de-you-huabu-chong-shuo-ming" aria-label="Permalink to &quot;ğŸš€ Go 1.17+ çš„ä¼˜åŒ–ï¼ˆè¡¥å……è¯´æ˜ï¼‰&quot;">â€‹</a></h2><p>ä» <strong>Go 1.17</strong> å¼€å§‹ï¼Œæ ‡å‡†åº“å¯¹ child context çš„ç®¡ç†è¿›è¡Œäº†<strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š</p><ul><li>ä½¿ç”¨æ›´ç´§å‡‘çš„æ•°æ®ç»“æ„å­˜å‚¨ childrenï¼›</li><li>å‡å°‘é—´æ¥æŒ‡é’ˆå’Œåˆ†é…ï¼›</li><li>åœ¨å¤§é‡çŸ­ç”Ÿå‘½å‘¨æœŸ context çš„åœºæ™¯ä¸‹ï¼ˆå¦‚é«˜é¢‘ HTTP è¯·æ±‚ï¼‰ï¼Œ<strong>æ˜¾è‘—é™ä½ GC å‹åŠ›å’Œå†…å­˜å ç”¨</strong>ã€‚</li></ul><p>ä½†è¿™<strong>ä¸æ”¹å˜è¯­ä¹‰</strong>ï¼Œä»…æ˜¯æ€§èƒ½æ”¹è¿›ã€‚</p><h2 id="zui-jia-shi-jian" tabindex="-1">âœ… æœ€ä½³å®è·µ <a class="header-anchor" href="#zui-jia-shi-jian" aria-label="Permalink to &quot;âœ… æœ€ä½³å®è·µ&quot;">â€‹</a></h2><h3 id="yong-yuan-bu-yao-chuan-di-nil-context" tabindex="-1">æ°¸è¿œä¸è¦ä¼ é€’ <code>nil</code> context <a class="header-anchor" href="#yong-yuan-bu-yao-chuan-di-nil-context" aria-label="Permalink to &quot;æ°¸è¿œä¸è¦ä¼ é€’ \`nil\` context&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âŒ é”™è¯¯</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TODO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä»…ç”¨äºå ä½ï¼</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">someFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">nil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ç»å¯¹ç¦æ­¢ï¼</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ­£ç¡®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Background</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸»å‡½æ•°ã€åˆå§‹åŒ–ã€æµ‹è¯•</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æˆ–ä» HTTP handlerã€gRPC æ–¹æ³•ç­‰æ¥æ”¶çš„ ctx</span></span></code></pre></div><blockquote><p><strong>è§„åˆ™</strong>ï¼š</p><ul><li>åœ¨<strong>ä¸çŸ¥é“ç”¨ä»€ä¹ˆ context</strong>æ—¶ â†’ ç”¨ <code>context.TODO()</code>ï¼ˆä½†åº”å°½å¿«æ›¿æ¢ï¼‰</li><li>åœ¨<strong>é¡¶å±‚å…¥å£</strong>ï¼ˆmainã€testã€handlerï¼‰â†’ ç”¨ <code>context.Background()</code></li></ul></blockquote><h3 id="jiang-context-zuo-wei-han-shu-de-di-yi-ge-can-shuqie-bu-cun-ru-struct" tabindex="-1">å°† context ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸”ä¸å­˜å…¥ struct <a class="header-anchor" href="#jiang-context-zuo-wei-han-shu-de-di-yi-ge-can-shuqie-bu-cun-ru-struct" aria-label="Permalink to &quot;å°† context ä½œä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¸”ä¸å­˜å…¥ struct&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ¨èï¼šæ˜¾å¼ä¼ é€’</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Process</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âŒ åæ¨¡å¼ï¼šå­˜å…¥ structï¼ˆéšè—ä¾èµ–ã€éš¾ä»¥è¿½è¸ªï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Service</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // ä¸è¦è¿™æ ·åšï¼</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><blockquote><p><strong>åŸå› </strong>ï¼š</p><ul><li>æ˜ç¡®ç”Ÿå‘½å‘¨æœŸè¾¹ç•Œ</li><li>é¿å… context è¢«æ„å¤–å¤ç”¨æˆ–å»¶é•¿ç”Ÿå‘½å‘¨æœŸ</li><li>ç¬¦åˆ Go å®˜æ–¹ API é£æ ¼ï¼ˆå¦‚ <code>http.Request.WithContext</code>ï¼‰</li></ul></blockquote><h3 id="ji-shi-diao-yong-cancel-han-shubi-mian-zi-yuan-xie-lou" tabindex="-1">åŠæ—¶è°ƒç”¨ cancel å‡½æ•°ï¼ˆé¿å…èµ„æºæ³„æ¼ï¼‰ <a class="header-anchor" href="#ji-shi-diao-yong-cancel-han-shubi-mian-zi-yuan-xie-lou" aria-label="Permalink to &quot;åŠæ—¶è°ƒç”¨ cancel å‡½æ•°ï¼ˆé¿å…èµ„æºæ³„æ¼ï¼‰&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ­£ç¡®ï¼šä½¿ç”¨ defer ç¡®ä¿ cancel è¢«è°ƒç”¨</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(parentCtx, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.Second)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å³ä½¿å‡½æ•°æå‰è¿”å›ä¹Ÿä¼šæ‰§è¡Œ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">resp, err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> client.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Do</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(req.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx))</span></span></code></pre></div><blockquote><p>âš ï¸ <strong>ä¸è°ƒç”¨ cancel ä¼šå¯¼è‡´ï¼š</strong></p><ul><li>å®šæ—¶å™¨ï¼ˆWithTimeout/WithDeadlineï¼‰ä¸ä¼šè¢«é‡Šæ”¾ â†’ <strong>å†…å­˜æ³„æ¼</strong></li><li>çˆ¶ context æ— æ³•å®‰å…¨é‡Šæ”¾å­ context çš„å¼•ç”¨</li></ul></blockquote><h3 id="contextwithvalue-de-zheng-que-shi-yong" tabindex="-1"><code>context.WithValue</code> çš„æ­£ç¡®ä½¿ç”¨ <a class="header-anchor" href="#contextwithvalue-de-zheng-que-shi-yong" aria-label="Permalink to &quot;\`context.WithValue\` çš„æ­£ç¡®ä½¿ç”¨&quot;">â€‹</a></h3><h4 id="jin-yong-yu-chuan-di-qing-qiu-fan-wei-de-yuan-shu-ju" tabindex="-1">ä»…ç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´çš„å…ƒæ•°æ® <a class="header-anchor" href="#jin-yong-yu-chuan-di-qing-qiu-fan-wei-de-yuan-shu-ju" aria-label="Permalink to &quot;ä»…ç”¨äºä¼ é€’è¯·æ±‚èŒƒå›´çš„å…ƒæ•°æ®&quot;">â€‹</a></h4><p>Go å®˜æ–¹æ–‡æ¡£æ˜ç¡®æŒ‡å‡ºï¼š</p><blockquote><p>&quot;Context values are for request-scoped data that transits processes and APIs, not for passing optional parameters to functions.&quot;</p></blockquote><p>å› æ­¤ï¼ŒContext çš„å€¼åªåº”ç”¨äºè·¨ API è¾¹ç•Œçš„è¯·æ±‚ä½œç”¨åŸŸæ•°æ®ï¼ˆå¦‚é“¾è·¯è¿½è¸ªã€è®¤è¯ä¿¡æ¯ï¼‰ï¼Œ<strong>ä¸è¦ç”¨äºä¼ é€’å¯é€‰å‡½æ•°å‚æ•°ã€é…ç½®ç­‰</strong>ï¼Œå› ä¸ºåˆ›å»ºçš„ context ä¼šè´¯ç©¿è°ƒç”¨é“¾ï¼Œå¯¼è‡´æ¥å£ä¸æ¸…æ™°ã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ­£ç¡®ï¼šç”¨äºé“¾è·¯è¿½è¸ª</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ctxKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // è‡ªå®šä¹‰éå¯¼å‡ºç±»å‹ä½œ key</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> requestIDKey</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> ctxKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;requestID&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, requestIDKey, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;abc123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">id, ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(requestIDKey).(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å®é™…ä½¿ç”¨æ—¶åŠ ç±»å‹æ–­è¨€ä¿æŠ¤</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> !</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ok {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errors.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">New</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;request ID not found in context or wrong type&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æ»¥ç”¨ WithValue ä¼šå¯¼è‡´ï¼š</p><ul><li><p>ä»£ç éšå¼ä¾èµ–ï¼ˆéš¾ä»¥æµ‹è¯•ï¼‰</p></li><li><p>æ€§èƒ½ä¸‹é™ï¼ˆé“¾å¼æŸ¥æ‰¾ï¼‰ï¼šæ¯æ¬¡ <code>WithValue</code> éƒ½åˆ†é…æ–°ç»“æ„ä½“ï¼›<code>Value()</code> æŸ¥æ‰¾æ˜¯ O(N)ï¼ˆN = context é“¾æ·±åº¦ï¼‰ã€‚é¿å…é«˜é¢‘åµŒå¥—</p></li><li><p>è°ƒç”¨é“¾æ··ä¹±ï¼ˆâ€œé­”æ³•å˜é‡â€ï¼‰</p></li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âŒ é”™è¯¯ç¤ºèŒƒï¼šæ»¥ç”¨ WithValue ä¼ é€’ä¸šåŠ¡å‚æ•°</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;timeout&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">30</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.Second) </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// ä¸è¦è¿™æ ·</span></span></code></pre></div><h4 id="shi-yong-zi-ding-yi-fei-dao-chu-struct-bi-mian-chong-tu" tabindex="-1">ä½¿ç”¨è‡ªå®šä¹‰éå¯¼å‡º struct é¿å…å†²çª <a class="header-anchor" href="#shi-yong-zi-ding-yi-fei-dao-chu-struct-bi-mian-chong-tu" aria-label="Permalink to &quot;ä½¿ç”¨è‡ªå®šä¹‰éå¯¼å‡º struct é¿å…å†²çª&quot;">â€‹</a></h4><p>åŸå› åœ¨äº</p><ul><li><strong>é¿å…å‘½åå†²çª</strong>ï¼šå¦‚æœç”¨å­—ç¬¦ä¸² <code>&quot;user_id&quot;</code> ä½œ keyï¼Œä¸åŒåŒ…å¯èƒ½ä½¿ç”¨ç›¸åŒå­—ç¬¦ä¸²ï¼Œå¯¼è‡´å€¼è¢«æ„å¤–è¦†ç›–æˆ–è¯»é”™ã€‚</li><li><strong>ç±»å‹å®‰å…¨</strong>ï¼š<code>struct{}</code> æ˜¯å”¯ä¸€ç±»å‹ï¼ˆunexportedï¼‰ï¼Œåªæœ‰å®šä¹‰å®ƒçš„åŒ…èƒ½æ„é€ è¯¥ keyï¼Œå¤©ç„¶éš”ç¦»ã€‚</li><li><strong>é›¶å†…å­˜å¼€é”€</strong> ï¼š<code>struct{}</code> å ç”¨ 0 å­—èŠ‚ï¼Œé«˜æ•ˆã€‚</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> traceIDKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{} </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// æ¨èç”¨ \`struct{}\` ç±»å‹ä½œ keyï¼Ÿ</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Good âœ…</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">traceIDKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;xxx-xxx&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tid, ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">traceIDKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}).(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); ok {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;traceID:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, tid)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bad âŒ å­—ç¬¦ä¸²å­—é¢é‡ï¼ˆæœ€å·®ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// SA1029: should not use built-in type string as key for value; define your own type to avoid collisions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;abc-123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bad âŒ å¯¼å‡ºçš„å­—ç¬¦ä¸²ç±»å‹ï¼ˆæ˜“å†²çªï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserIDKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // é¦–å­—æ¯å¤§å†™ â†’ å¯¼å‡º</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> UserIDKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;user_id&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, UserIDKey, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Bad âŒ éå¯¼å‡ºå­—ç¬¦ä¸²ç±»å‹ï¼ˆä»ä¸ç†æƒ³ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> userIDKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> string</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // å°å†™ â†’ éå¯¼å‡º</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">userIDKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;user_id&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;123&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>åœ¨ HTTP ä¸­é—´ä»¶ä¸­ï¼Œä½¿ç”¨ <code>userAgentContextKey{}</code> ä½œä¸º key çš„ç¤ºä¾‹ï¼Œä½†æ˜¯è¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªè¾…åŠ©å‡½æ•° <code>GetUserAgent</code> æ¥è·å–å€¼ï¼Œé¿å…ç›´æ¥æš´éœ² keyï¼š</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">package</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> middleware</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">import</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">context</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    &quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">net/http</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// éå¯¼å‡ºçš„ key ç±»å‹ï¼Œé˜²æ­¢å¤–éƒ¨åŒ…æ„å¤–å†²çª</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> userAgentContextKey</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// å¯¼å‡ºçš„å‡½æ•°ï¼Œä¾›å¤–éƒ¨å®‰å…¨è¯»å– User-Agent</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GetUserAgent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">ctx</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> val, ok </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">userAgentContextKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}).(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">string</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">); ok {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> val</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> UserAgentMiddleware</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> NewUserAgentMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UserAgentMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UserAgentMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">m </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">UserAgentMiddleware</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Handle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">next</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HandlerFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">HandlerFunc</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">w</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResponseWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        val </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.Header.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Get</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;User-Agent&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        reqCtx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithValue</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(reqCtx, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">userAgentContextKey</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{}, val)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        newReq </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        next</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(w, newReq)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><h3 id="jian-ting-done-tong-dao-yi-xiang-ying-qu-xiao" tabindex="-1">ç›‘å¬ Done é€šé“ä»¥å“åº”å–æ¶ˆ <a class="header-anchor" href="#jian-ting-done-tong-dao-yi-xiang-ying-qu-xiao" aria-label="Permalink to &quot;ç›‘å¬ Done é€šé“ä»¥å“åº”å–æ¶ˆ&quot;">â€‹</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // ä¼˜é›…é€€å‡ºï¼šæ¸…ç†èµ„æºã€å›æ»šäº‹åŠ¡ç­‰</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Println</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;operation canceled:&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">slowOperation</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><ul><li><code>ctx.Err()</code> ä¼šè¿”å› <code>Canceled</code> æˆ– <code>DeadlineExceeded</code></li></ul><h3 id="http-fu-wu-de-sheng-ming-zhou-qi-guan-li" tabindex="-1">HTTP æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† <a class="header-anchor" href="#http-fu-wu-de-sheng-ming-zhou-qi-guan-li" aria-label="Permalink to &quot;HTTP æœåŠ¡çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†&quot;">â€‹</a></h3><p>åœ¨ Go çš„ <code>net/http</code> åŒ…ä¸­ï¼Œ<code>http.Request</code> ç»“æ„ä½“è‡ª Go 1.7 èµ·åŒ…å«äº†ä¸€ä¸ª <code>Context</code> å­—æ®µï¼Œè¡¨ç¤ºä¸è¯¥è¯·æ±‚å…³è”çš„ä¸Šä¸‹æ–‡ã€‚è¿™ä¸ªä¸Šä¸‹æ–‡ä¼šåœ¨è¯·æ±‚å¤„ç†è¿‡ç¨‹ä¸­è‡ªåŠ¨ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬å–æ¶ˆä¿¡å·çš„ä¼ æ’­ã€‚</p><ul><li>å½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥ï¼ˆå¦‚å…³é—­æµè§ˆå™¨ã€curl ä¸­æ–­ç­‰ï¼‰ï¼Œ<strong>Go çš„ HTTP æœåŠ¡å™¨ä¼šè‡ªåŠ¨å–æ¶ˆè¯¥è¯·æ±‚çš„ context</strong>ã€‚</li><li>å¦‚æœè¯·æ±‚è®¾ç½®äº†è¶…æ—¶ï¼ˆä¾‹å¦‚é€šè¿‡ <code>http.Server.ReadTimeout</code>ã€<code>WriteTimeout</code>ï¼Œæˆ–åœ¨ handler ä¸­ç”¨ <code>context.WithTimeout</code> åŒ…è£¹ï¼‰ï¼Œè¶…æ—¶åä¹Ÿä¼šè§¦å‘ <code>DeadlineExceeded</code>ã€‚</li><li>å› æ­¤ï¼Œåœ¨ handler ä¸­ç›‘å¬ <code>ctx.Done()</code> å¯ä»¥åŠæ—¶é‡Šæ”¾èµ„æºã€é¿å…æ— æ„ä¹‰çš„è®¡ç®—ã€‚</li></ul><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handler</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">w</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ResponseWriter</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">http</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Request</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // æ¨¡æ‹Ÿä¸€ä¸ªå¯èƒ½è€—æ—¶çš„æ“ä½œ</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    select</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">doSomeWork</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx):</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fmt.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Fprint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(w, result)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Done</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">():</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        log.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Printf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Handler canceled: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%v</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, ctx.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Err</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">())</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        http.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(w, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;Request canceled&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, http.StatusRequestTimeout)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>æœ€ä½³å®è·µï¼š</p><ul><li><p><strong>æ‰€æœ‰ä¸‹æ¸¸æ“ä½œéƒ½åº”ä¼ é€’ <code>r.Context()</code></strong></p><p>åŒ…æ‹¬æ•°æ®åº“æŸ¥è¯¢ï¼ˆå¦‚ GORM çš„ <code>WithContext(ctx)</code>ï¼‰ã€HTTP å®¢æˆ·ç«¯è°ƒç”¨ï¼ˆ<code>http.Client.Do(req.WithContext(ctx))</code>ï¼‰ã€gRPC è°ƒç”¨ç­‰ã€‚</p></li><li><p><strong>ä¸è¦å¿½ç•¥ <code>ctx.Done()</code> ä¿¡å·</strong></p><p>å°¤å…¶æ˜¯åœ¨å¾ªç¯ã€é•¿è½®è¯¢ã€æµå¼å¤„ç†æˆ–é‡è¯•é€»è¾‘ä¸­ï¼Œåº”å®šæœŸæ£€æŸ¥ <code>ctx.Err()</code> æˆ– <code>&lt;-ctx.Done()</code>ã€‚</p></li><li><p><strong>ä¸è¦æ›¿æ¢æ ¹ contextï¼ˆé™¤éå¿…è¦ï¼‰</strong></p><p>é€šå¸¸åº”åŸºäº <code>r.Context()</code> æ´¾ç”Ÿæ–°çš„ä¸Šä¸‹æ–‡ï¼ˆå¦‚æ·»åŠ å€¼ã€è®¾ç½®è¶…æ—¶ï¼‰ï¼Œè€Œä¸æ˜¯ä» <code>context.Background()</code> é‡æ–°å¼€å§‹ï¼Œå¦åˆ™ä¼šæ–­å¼€ä¸å®¢æˆ·ç«¯å–æ¶ˆä¿¡å·çš„è¿æ¥ã€‚</p><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// âœ… æ­£ç¡®ï¼šåŸºäºè¯·æ±‚ä¸Šä¸‹æ–‡æ´¾ç”Ÿ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">childCtx, cancel </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> context.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithTimeout</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(r.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Context</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">time.Second)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">defer</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> cancel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div></li></ul>`,125)]))}const c=i(h,[["render",l]]);export{o as __pageData,c as default};
